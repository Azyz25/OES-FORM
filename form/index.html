<!DOCTYPE html>
<html lang="ar" dir="rtl">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>ØªØ³Ø¬ÙŠÙ„ Ø§Ù„Ù…Ø¯Ø±Ø¨ÙŠÙ†</title>
  <style>

        @font-face {
  font-family: 'TheSansPlain';
  src: url('TheSans-Plain.OTF') format('opentype');
  font-weight: normal;
  font-style: normal;
}

/* 2) ØªØ·Ø¨ÙŠÙ‚ Ø§Ù„Ø®Ø· Ø¹Ù„Ù‰ Ø§Ù„ØµÙØ­Ø© ÙƒÙ„Ù‡Ø§ */
html, body, * {
  font-family: 'TheSansPlain', sans-serif !important;
}
    body {
      background-color: #f3f3f3;
      padding: 2rem;
    }
    header {
      text-align: center;
      margin-bottom: 1rem;
    }
    header img {
      max-width: 150px;
    }
    .stats {
      display: flex;
      justify-content: center;
      gap: 2rem;
      margin-bottom: 2rem;
      font-size: 1.1rem;
    }
    .stats span {
      color: #007acc;
      font-weight: bold;
    }
    #courses {
      display: grid;
      grid-template-columns: repeat(auto-fit, minmax(280px, 1fr));
      gap: 1rem;
    }
    .course-card {
      background-color: #fff;
      border-radius: 25px;
      padding: 1rem;
      box-shadow: 0 2px 8px rgba(0,0,0,0.1);
      display: flex;
      flex-direction: column;
      justify-content: space-between;
    }
    .course-card img {
      max-width: 100%;
      max-height: 250px;
      object-fit: cover;
      border-radius: 25px;
      margin-bottom: 0.5rem;
    }
    .btn {
      background: linear-gradient(to right, #212856, #4c5fac);
      color: white;
      padding: 0.5rem 1rem;
      border: none;
      border-radius: 15px;
      cursor: pointer;
      margin-top: 1rem;
    }
    #registerModal {
      display: none;
      position: fixed;
      top: 0; right: 0; bottom: 0; left: 0;
      background: rgba(0,0,0,0.5);
      justify-content: center;
      align-items: center;
      z-index: 999;
    }
    .modal-content {
      background: white;
      padding: 1rem;
      border-radius: 12px;
      width: 90%;
      max-width: 400px;
      position: relative;
    }
    .modal-content .close-btn {
      position: absolute;
      top: 10px;
      right: 10px;
      background: red;
      color: white;
      border: none;
      border-radius: 50%;
      width: 25px;
      height: 25px;
      font-size: 16px;
      cursor: pointer;
    }
input#name {
    width: 95% !important;
    margin-top: 10px;
    margin-bottom: 10px;
    height: 50px;
    border: solid 3px #d6d4d4;
    border-radius: 25px;
}

input#email {
    width: 95% !important;
    margin-top: 10px;
    margin-bottom: 10px;
    height: 50px;
    border: solid 3px #d6d4d4;
    border-radius: 25px;
}

input#nationalId {
    width: 95% !important;
    margin-top: 10px;
    margin-bottom: 10px;
    height: 50px;
    border: solid 3px #d6d4d4;
    border-radius: 25px;
}
    input#phone {
    width: 95% !important;
    margin-top: 10px;
    margin-bottom: 10px;
    height: 50px;
    border: solid 3px #d6d4d4;
    border-radius: 25px;
}
    .success-message {
      text-align: center;
      font-size: 1.2rem;
      color: green;
      display: none;
      animation: fadeIn 0.5s ease forwards;
    }
    .grid-periods {
      display: grid;
      grid-template-columns: repeat(auto-fit, minmax(120px, 1fr));
      gap: 10px;
      margin-top: 10px;
    }
    .period-box {
      background-color: #e0f0ff;
      padding: 10px;
      border-radius: 8px;
      text-align: center;
      cursor: pointer;
      transition: 0.3s;
      border: 2px solid transparent;
    }
    .period-box.selected {
      background-color: #007acc;
      color: white;
      border-color: #007acc;
    }
    .period-box.disabled {
      background-color: #ccc;
      cursor: not-allowed;
      opacity: 0.5;
    }
    .hint {
      font-size: 0.8rem;
      color: #888;
    }

    .logo{

        max-width: 200px;

    }
  </style>
  </head>
  <header>
    <img class="logo" src="./OES-logo.svg" alt="Ø´Ø¹Ø§Ø± Ø§Ù„Ø¬Ù…Ø¹ÙŠØ©">
  </header>

  <h2 style="text-align: center;">Ø§Ù„Ø¯ÙˆØ±Ø§Øª Ø§Ù„Ù…ØªØ§Ø­Ø©</h2>
  <div class="stats">
    <div>ğŸ“‹ Ø¹Ø¯Ø¯ Ø§Ù„Ø¯ÙˆØ±Ø§Øª Ø§Ù„Ù…Ù†Ø´ÙˆØ±Ø©: <span id="totalCount">0</span></div>
    <div>âœ… Ø§Ù„Ù…Ø´ØºÙˆÙ„Ø©: <span id="takenCount">0</span></div>
    <div>ğŸ“š Ø§Ù„Ù…ØªØ¨Ù‚ÙŠØ©: <span id="availableCount">0</span></div>
  </div>

  <div id="courses"></div>

  <div id="registerModal">
    <div class="modal-content">
      <button class="close-btn" onclick="closeModal()">Ã—</button>
      <h3>ØªØ³Ø¬ÙŠÙ„ ÙÙŠ Ø§Ù„Ø¯ÙˆØ±Ø©</h3>
      <form id="registerForm">
        <input type="hidden" id="selectedCourseId">
        <input type="text" id="name" placeholder="Ø§Ù„Ø§Ø³Ù… Ø§Ù„Ø«Ù„Ø§Ø«ÙŠ" required>
        <input type="email" id="email" placeholder="Ø§Ù„Ø¨Ø±ÙŠØ¯ Ø§Ù„Ø¥Ù„ÙƒØªØ±ÙˆÙ†ÙŠ" required>
        <input type="text" id="phone" placeholder="Ø±Ù‚Ù… Ø§Ù„Ø¬ÙˆØ§Ù„ (05XXXXXXXX)" maxlength="10" required>
        <div class="hint">Ù…Ø«Ø§Ù„: 05XXXXXXXX</div>
        <input type="text" id="nationalId" placeholder="Ø±Ù‚Ù… Ø§Ù„Ù‡ÙˆÙŠØ© Ø§Ù„ÙˆØ·Ù†ÙŠØ©" maxlength="10" required>
        <div class="hint">Ù…Ø«Ø§Ù„: 10 Ø£Ø±Ù‚Ø§Ù… ÙÙ‚Ø·</div>
        <div id="periodsGrid" class="grid-periods"></div>
        <button class="btn" type="submit">Ø¥Ø±Ø³Ø§Ù„</button>
        <div class="success-message" id="successMessage">âœ… ØªÙ… Ø§Ù„ØªØ³Ø¬ÙŠÙ„ Ø¨Ù†Ø¬Ø§Ø­</div>
      </form>
    </div>
  </div>
    <!-- Firebase SDK -->
  <script type="module">
    import { initializeApp } from "https://www.gstatic.com/firebasejs/10.12.2/firebase-app.js";
    import { getDatabase, ref, onValue, set, update, get, push } from "https://www.gstatic.com/firebasejs/10.12.2/firebase-database.js";

    const firebaseConfig = {
      apiKey: atob("QWl6YVN5QmxzWS1NTXhCekNjNm44WHotWjlIMmJ1dW40anN6SQ=="),
      authDomain: "abbait-4e902.firebaseapp.com",
      databaseURL: "https://abbait-4e902-default-rtdb.firebaseio.com",
      projectId: "abbait-4e902",
      storageBucket: "abbait-4e902.appspot.com",
      messagingSenderId: "12872633784",
      appId: "1:12872633784:web:dc8ff66d9bc6c0eb38134d"
    };

    const app = initializeApp(firebaseConfig);
    const db = getDatabase(app);

    const coursesContainer = document.getElementById("courses");
    const modal = document.getElementById("registerModal");
    const form = document.getElementById("registerForm");
    const successMsg = document.getElementById("successMessage");
    const periodsGrid = document.getElementById("periodsGrid");

    const totalCount = document.getElementById("totalCount");
    const takenCount = document.getElementById("takenCount");
    const availableCount = document.getElementById("availableCount");

    let currentCourse = null;
    let selectedPeriod = null;

    function closeModal() {
      modal.style.display = "none";
      form.reset();
      successMsg.style.display = "none";
      selectedPeriod = null;
    }

    window.closeModal = closeModal;

    function openModal(courseId) {
      get(ref(db, "courses/" + courseId)).then(snapshot => {
        const course = snapshot.val();
        currentCourse = { id: courseId, ...course };
        document.getElementById("selectedCourseId").value = courseId;

        renderPeriods(course);
        modal.style.display = "flex";
      });
    }

    window.openModal = openModal;

    function renderPeriods(course) {
      periodsGrid.innerHTML = "";

      const times = course.time.split(",").map(t => t.trim());
      const taken = course.takenPeriods || [];

      times.forEach(time => {
        const div = document.createElement("div");
        div.className = "period-box";
        div.textContent = time;

        if (taken.includes(time)) {
          div.classList.add("disabled");
        } else {
          div.onclick = () => {
            selectedPeriod = time;
            document.querySelectorAll(".period-box").forEach(box => box.classList.remove("selected"));
            div.classList.add("selected");
          };
        }

        periodsGrid.appendChild(div);
      });
    }

    form.addEventListener("submit", async (e) => {
      e.preventDefault();

      const name = document.getElementById("name").value.trim();
      const email = document.getElementById("email").value.trim();
      const phone = document.getElementById("phone").value.trim();
      const nationalId = document.getElementById("nationalId").value.trim();

      if (!/^05\d{8}$/.test(phone)) return alert("Ø±Ù‚Ù… Ø§Ù„Ø¬ÙˆØ§Ù„ Ù„Ø§Ø²Ù… ÙŠØ¨Ø¯Ø£ Ø¨Ù€ 05 ÙˆÙŠØªÙƒÙˆÙ† Ù…Ù† 10 Ø£Ø±Ù‚Ø§Ù….");
      if (!/^\d{10}$/.test(nationalId)) return alert("Ø±Ù‚Ù… Ø§Ù„Ù‡ÙˆÙŠØ© Ù„Ø§Ø²Ù… ÙŠÙƒÙˆÙ† 10 Ø£Ø±Ù‚Ø§Ù….");

      if (!selectedPeriod) return alert("Ø§Ù„Ø±Ø¬Ø§Ø¡ Ø§Ø®ØªÙŠØ§Ø± ÙØªØ±Ø©.");

      const traineeData = {
        name, email, phone, nationalId,
        courseId: currentCourse.id,
        courseTitle: currentCourse.title,
        date: currentCourse.date,
        time: selectedPeriod,
        duration: currentCourse.duration,
        place: currentCourse.place || "",
        category: currentCourse.category || "",
        target: currentCourse.target || "",
        registeredAt: new Date().toISOString()
      };

      const traineeRef = push(ref(db, "trainees"));
      await set(traineeRef, traineeData);

      // Ù†Ø­Ø¯Ø« takenPeriods Ø¯Ø§Ø®Ù„ Ø§Ù„Ø¯ÙˆØ±Ø©
      const updatedTaken = [...(currentCourse.takenPeriods || []), selectedPeriod];
      await update(ref(db, "courses/" + currentCourse.id), { takenPeriods: updatedTaken });

      successMsg.style.display = "block";
      form.querySelector("button").disabled = true;

      setTimeout(() => {
        closeModal();
        fetchCourses();
        form.querySelector("button").disabled = false;
      }, 2500);
    });
function fetchCourses() {
  onValue(ref(db, "courses"), (snapshot) => {
    coursesContainer.innerHTML = "";
    let total = 0, taken = 0, available = 0;

    if (snapshot.exists()) {
      const data = snapshot.val();

      Object.entries(data).forEach(([id, course]) => {
        const times = course.time?.split(",").map(t => t.trim()) || [];
        const takenList = course.takenPeriods || [];

        // Ù†Ø¬Ù…Ø¹ ÙØªØ±Ø© Ù„ÙƒÙ„ Ø¯ÙˆØ±Ø©
        total += times.length;

        // Ù†Ø¬Ù…Ø¹ Ø§Ù„ÙØªØ±Ø§Øª Ø§Ù„Ù…Ø´ØºÙˆÙ„Ø©
        taken += takenList.length;

        // Ù†Ø±Ø³Ù… ÙƒÙ„ ÙƒØ§Ø±Ø¯ Ø¯ÙˆØ±Ø© Ø¨Ù†ÙØ³ Ø·Ø±ÙŠÙ‚Ø© Ù‚Ø¨Ù„
        const div = document.createElement("div");
        div.className = "course-card";
        div.innerHTML = `
          <img src="${course.image || './default-image.svg'}" onerror="this.src='./default-image.svg'" />
          <h4>${course.title}</h4>
          <p>${course.description}</p>
          <p><span class="icon">ğŸ“…</span> ${course.date}</p>
          <p><span class="icon">â°</span> ${course.time}</p>
          <button class="btn" onclick="openModal('${id}')">Ø³Ø¬Ù„</button>
        `;
        coursesContainer.appendChild(div);
      });

      // Ø§Ù„Ù…ØªØ¨Ù‚ÙŠ = Ø§Ù„ÙƒÙ„ - Ø§Ù„Ù…Ø´ØºÙˆÙ„Ø©
      available = total - taken;
    }

    totalCount.textContent     = total;
    takenCount.textContent     = taken;
    availableCount.textContent = available;
  });
}

    fetchCourses();
  </script>
</body>
</html>