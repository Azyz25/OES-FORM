<!DOCTYPE html>
<html lang="ar" dir="rtl">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <link rel="icon" href="OES-logo.svg" type="image/svg+xml" />
  <title>ØªØ³Ø¬ÙŠÙ„ Ø§Ù„Ù…Ø¯Ø±Ø¨ÙŠÙ†</title>
  <style>

        @font-face {
  font-family: 'TheSansPlain';
  src: url('TheSans-Plain.otf') format('opentype');
  font-weight: normal;
  font-style: normal;
}

/* 2) ØªØ·Ø¨ÙŠÙ‚ Ø§Ù„Ø®Ø· Ø¹Ù„Ù‰ Ø§Ù„ØµÙØ­Ø© ÙƒÙ„Ù‡Ø§ */
html, body, * {
  font-family: 'TheSansPlain', sans-serif !important;
}
    body {
      background-color: #f3f3f3;
      padding: 2rem;
    }
    header {
      text-align: center;
      margin-bottom: 1rem;
    }
    header img {
      max-width: 150px;
    }
    .stats {
      display: flex;
      justify-content: center;
      gap: 2rem;
      margin-bottom: 2rem;
      font-size: 1.1rem;
    }
    .stats span {
      color: #007acc;
      font-weight: bold;
    }
    #courses {
      display: grid;
      grid-template-columns: repeat(auto-fit, minmax(280px, 1fr));
      gap: 1rem;
    }
    .course-card {
      background-color: #fff;
      border-radius: 25px;
      padding: 1rem;
      box-shadow: 0 2px 8px rgba(0,0,0,0.1);
      display: flex;
      flex-direction: column;
      justify-content: space-between;
    }
    .course-card img {
      max-width: 100%;
      max-height: 250px;
      object-fit: cover;
      border-radius: 25px;
      margin-bottom: 0.5rem;
    }
    .btn {
      background: linear-gradient(to right, #212856, #4c5fac);
      color: white;
      padding: 0.5rem 1rem;
      border: none;
      border-radius: 15px;
      cursor: pointer;
      margin-top: 1rem;
    }
    #registerModal {
      display: none;
      position: fixed;
      top: 0; right: 0; bottom: 0; left: 0;
      background: rgba(0,0,0,0.5);
      justify-content: center;
      align-items: center;
      z-index: 999;
    }
  .modal-content {
  background: white;
  padding: 1rem;
  border-radius: 20px;
  width: 90%;
  max-width: 400px;
  position: relative;
  overflow-y: auto; /* ÙŠØ®Ù„ÙŠÙ‡ scroll Ø§Ø°Ø§ ØµØ§Ø± Ø·ÙˆÙŠÙ„ */
  max-height: 90vh; /* ÙŠØ­Ø¯Ø¯ Ø§Ù„Ø·ÙˆÙ„ Ø§Ù„Ø£Ù‚ØµÙ‰ */
}

/* Ù„Ù„Ø´Ø§Ø´Ø§Øª Ø§Ù„ÙƒØ¨ÙŠØ±Ø© */
@media (min-width: 1024px) {
  .modal-content {
    max-width: 700px; /* Ø£Ùˆ Ø£ÙŠ Ø­Ø¬Ù… ÙŠÙ†Ø§Ø³Ø¨ Ø¹Ø±Ø¶ Ø§Ù„Ù„Ø§Ø¨ØªÙˆØ¨ */
    display: flex;
    flex-direction: column;
  }
}

    .modal-content .close-btn {
      position: absolute;
      top: 10px;
      right: 10px;
      background: red;
      color: white;
      border: none;
      border-radius: 50%;
      width: 25px;
      height: 25px;
      font-size: 16px;
      cursor: pointer;
    }
input#name {
    width: 95% !important;
    margin-top: 10px;
    margin-bottom: 10px;
    height: 50px;
    border: solid 3px #d6d4d4;
    border-radius: 25px;
}

input#email {
    width: 95% !important;
    margin-top: 10px;
    margin-bottom: 10px;
    height: 50px;
    border: solid 3px #d6d4d4;
    border-radius: 25px;
}

input#nationalId {
    width: 95% !important;
    margin-top: 10px;
    margin-bottom: 10px;
    height: 50px;
    border: solid 3px #d6d4d4;
    border-radius: 25px;
}

input#workname {
    width: 95% !important;
    margin-top: 10px;
    margin-bottom: 10px;
    height: 50px;
    border: solid 3px #d6d4d4;
    border-radius: 25px;
}


    input#phone {
    width: 95% !important;
    margin-top: 10px;
    margin-bottom: 10px;
    height: 50px;
    border: solid 3px #d6d4d4;
    border-radius: 25px;
}
    .success-message {
      text-align: center;
      font-size: 1.2rem;
      color: green;
      display: none;
      animation: fadeIn 0.5s ease forwards;
    }
    .grid-periods {
      display: grid;
      grid-template-columns: repeat(auto-fit, minmax(120px, 1fr));
      gap: 10px;
      margin-top: 10px;
    }
    .period-box {
      background-color: #e0f0ff;
      padding: 10px;
      border-radius: 8px;
      text-align: center;
      cursor: pointer;
      transition: 0.3s;
      border: 2px solid transparent;
    }
    .period-box.selected {
      background-color: #007acc;
      color: white;
      border-color: #007acc;
    }
    .period-box.disabled {
      background-color: #ccc;
      cursor: not-allowed;
      opacity: 0.5;
    }
    .hint {
      font-size: 0.8rem;
      color: #888;
    }

    .logo{

        max-width: 200px;

    }

    .period-box {
  background-color: #e0f0ff;
  padding: 10px;
  border-radius: 25px; /* Ù…Ø¯ÙˆØ± Ø­Ù„Ùˆ */
  text-align: center;
  cursor: pointer;
  transition: 0.3s;
  border: 2px solid transparent;
  margin-bottom: 10px;
}

.form-group label {
  font-weight: bold;
  margin-bottom: 8px;
    margin-top: 8px;
      margin-left: 8px;
  display: block;
}
input#cvFile {
  display: block;
  width: 94%;
  padding: 8px;
  border-radius: 8px;
  border: 2px dashed #4c5fac;
  background: #f9faff;
  cursor: pointer;
}
input#cvFile:hover {
  background: #eef4ff;
}


  </style>
  </head>
  <header>
    <img class="logo" src="./OES-logo.svg" alt="Ø´Ø¹Ø§Ø± Ø§Ù„Ø¬Ù…Ø¹ÙŠØ©">
  </header>

  <h2 style="text-align: center;">Ø§Ù„Ø¯ÙˆØ±Ø§Øª Ø§Ù„Ù…ØªØ§Ø­Ø©</h2>
  <div class="stats">
    <div>ğŸ“‹ Ø¹Ø¯Ø¯ Ø§Ù„Ø¯ÙˆØ±Ø§Øª Ø§Ù„Ù…Ù†Ø´ÙˆØ±Ø©: <span id="totalCount">0</span></div>
    <div>âœ… Ø§Ù„Ù…Ø´ØºÙˆÙ„Ø©: <span id="takenCount">0</span></div>
    <div>ğŸ“š Ø§Ù„Ù…ØªØ¨Ù‚ÙŠØ©: <span id="availableCount">0</span></div>
  </div>

  <div id="courses"></div>

  <div id="registerModal">
    <div class="modal-content">
      <button class="close-btn" onclick="closeModal()">Ã—</button>
      <h3>ØªØ³Ø¬ÙŠÙ„ ÙÙŠ Ø§Ù„Ø¯ÙˆØ±Ø©</h3>
      <form id="registerForm">
        <input type="hidden" id="selectedCourseId">
        <input type="text" id="name" placeholder="Ø§Ù„Ø§Ø³Ù… Ø§Ù„Ø«Ù„Ø§Ø«ÙŠ" required>
        <input type="text" id="workname" placeholder="Ø§Ù„Ù…Ø³Ù…Ù‰ Ø§Ù„ÙˆØ¸ÙŠÙÙŠ" required>
        <input type="email" id="email" placeholder="Ø§Ù„Ø¨Ø±ÙŠØ¯ Ø§Ù„Ø¥Ù„ÙƒØªØ±ÙˆÙ†ÙŠ" required>
        <input type="text" id="phone" placeholder="Ø±Ù‚Ù… Ø§Ù„Ø¬ÙˆØ§Ù„ (05XXXXXXXX)" maxlength="10" required>
        <div class="hint">Ù…Ø«Ø§Ù„: 05XXXXXXXX</div>
        <input type="text" id="nationalId" placeholder="Ø±Ù‚Ù… Ø§Ù„Ù‡ÙˆÙŠØ© Ø§Ù„ÙˆØ·Ù†ÙŠØ©" maxlength="10" required>
        <div class="hint">10 Ø£Ø±Ù‚Ø§Ù… ÙÙ‚Ø·</div>
<div class="form-group">
    <label for="cvFile">Ø±ÙØ¹ Ø§Ù„Ø³ÙŠØ±Ø© Ø§Ù„Ø°Ø§ØªÙŠØ© (PDF Ø£Ùˆ Word) - ( Ø§Ø®ØªÙŠØ§Ø±ÙŠ )</label>
    <input type="file" id="cvFile" accept=".pdf,.doc,.docx">
  </div>        <div id="periodsGrid" class="grid-periods"></div>
  <div class="form-group" style="display:flex; align-items:center; gap:8px; margin-top:1rem;">
  <input type="checkbox" id="agreePolicy" />
  <label for="agreePolicy">
    Ø£ÙˆØ§ÙÙ‚ Ø¹Ù„Ù‰ 
    <a href="https://example.com/policy" target="_blank" style="color:blue; text-decoration:underline;">
      Ø³ÙŠØ§Ø³Ø© Ø¹Ø¯Ù… Ø§Ù„Ø¥ÙØ´Ø§Ø¡
    </a>
  </label>
</div>

        <button class="btn" type="submit">Ø¥Ø±Ø³Ø§Ù„</button>
        <div class="success-message" id="successMessage">âœ… ØªÙ… Ø§Ù„ØªØ³Ø¬ÙŠÙ„ Ø¨Ù†Ø¬Ø§Ø­</div>
      </form>
    </div>
  </div>
    <!-- Firebase SDK -->
 <script type="module">
import { initializeApp } from "https://www.gstatic.com/firebasejs/10.12.2/firebase-app.js";
import {
  getDatabase,
  ref,
  onValue,
  get,
  push,
  set
} from "https://www.gstatic.com/firebasejs/10.12.2/firebase-database.js";
import {
  getStorage,
  ref as storageRef,
  uploadBytes,
  getDownloadURL
} from "https://www.gstatic.com/firebasejs/10.12.2/firebase-storage.js";

// 1) ØªÙ‡ÙŠØ¦Ø© Firebase
const firebaseConfig = {
  apiKey: atob("QWl6YVN5QmxzWS1NTXhCekNjNm44WHotWjlIMmJ1dW40anN6SQ=="),
  authDomain: "abbait-4e902.firebaseapp.com",
  databaseURL: "https://abbait-4e902-default-rtdb.firebaseio.com",
  projectId: "abbait-4e902",
  storageBucket: "abbait-4e902.appspot.com",
  messagingSenderId: "12872633784",
  appId: "1:12872633784:web:dc8ff66d9bc6c0eb38134d"
};
const app = initializeApp(firebaseConfig);
const db = getDatabase(app);
const storage = getStorage(app, "gs://dedoapp-865f7.appspot.com");

let selectedDate = null;
let selectedPeriod = null;
let currentCourse = null;

// 2) Ø¹Ù†Ø§ØµØ± Ø§Ù„ØµÙØ­Ø©
const coursesContainer  = document.getElementById("courses");
const modal             = document.getElementById("registerModal");
const form              = document.getElementById("registerForm");
const successMsg        = document.getElementById("successMessage");
const periodsGrid       = document.getElementById("periodsGrid");
const totalCount        = document.getElementById("totalCount");
const takenCount        = document.getElementById("takenCount");
const availableCount    = document.getElementById("availableCount");
// Ø¨Ø¹Ø¯ ØªØ¹Ø±ÙŠÙ formØŒ periodsGridØŒ Ø§Ù„Ø®â€¦
const agreeCheckbox = document.getElementById("agreePolicy");
const submitBtn     = form.querySelector('button[type="submit"]');
// Ø§Ø·Ù„Ø¹ Ø§Ù„Ø²Ø± Ù…Ø¹Ø·Ù‘Ù„ Ø¨Ø§Ù„Ø¨Ø¯Ø§ÙŠØ©
submitBtn.disabled = true;

// ÙØ¹Ù‘Ù„ Ø§Ù„Ø²Ø± Ø¨Ø³ ÙŠØ®ØªØ§Ø± Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù… Ø§Ù„Ù…ÙˆØ§ÙÙ‚Ø©
agreeCheckbox.addEventListener("change", () => {
  submitBtn.disabled = !agreeCheckbox.checked;
});

// ÙƒÙ…Ø§Ù† ØªØ¶ÙŠÙ ÙØ­Øµ Ø¥Ø¶Ø§ÙÙŠ Ù‚Ø¨Ù„ Ø§Ù„Ø¥Ø±Ø³Ø§Ù„ (Ø§Ø®ØªÙŠØ§Ø±ÙŠ)
form.addEventListener("submit", e => {
  if (!agreeCheckbox.checked) {
    e.preventDefault();
    return alert("ÙŠØ¬Ø¨ Ø§Ù„Ù…ÙˆØ§ÙÙ‚Ø© Ø¹Ù„Ù‰ Ø³ÙŠØ§Ø³Ø© Ø¹Ø¯Ù… Ø§Ù„Ø¥ÙØ´Ø§Ø¡ Ù‚Ø¨Ù„ Ø§Ù„Ø¥Ø±Ø³Ø§Ù„.");
  }
  // â€¦ Ø¨Ù‚ÙŠØ© Ù…Ø¹Ø§Ù„Ø¬ØªÙƒ
}, { once: true });

// 3) ÙØªØ­/Ø¥ØºÙ„Ø§Ù‚ Ø§Ù„Ù…ÙˆØ¯Ø§Ù„
window.openModal  = openModal;
window.closeModal = () => {
  modal.style.display     = "none";
  form.reset();
  successMsg.style.display= "none";
  selectedPeriod          = null;
};

// 4) Ø¬Ù„Ø¨ ÙˆØ¹Ø±Ø¶ Ø§Ù„ÙƒÙˆØ±Ø³Ø§Øª ÙˆØ§Ù„Ø¥Ø­ØµØ§Ø¦ÙŠØ§Øª
async function fetchCourses() {
  onValue(ref(db, "courses"), snap => {
    coursesContainer.innerHTML = "";
    if (!snap.exists()) return;
    Object.entries(snap.val()).forEach(([id, course]) => {
      const div = document.createElement("div");
      div.className = "course-card";
      div.innerHTML = `
        <img src="${course.image||'default-image.svg'}" 
             onerror="this.onerror=null;this.src='default-image.svg';" 
             alt="ØµÙˆØ±Ø© Ø§Ù„Ø¯ÙˆØ±Ø©"/>
        <h4>${course.title}</h4>
        <p>${course.description}</p>
        <p>Ø§Ù„ØªØµÙ†ÙŠÙ: ${course.category}</p>
        <p>Ø§Ù„Ù…Ø³ØªÙ‡Ø¯ÙÙˆÙ†: ${course.target}</p>
        <p>ğŸ“… ${course.date}</p>
        <p>â° ${course.time}</p>
        <button class="btn" onclick="openModal('${id}')">Ø³Ø¬Ù„</button>
      `;
      coursesContainer.appendChild(div);
    });
  });

  // Ø¥Ø­ØµØ§Ø¦ÙŠØ§Øª
  const coursesSnap = await get(ref(db, "courses"));
  let total = 0;
  if (coursesSnap.exists()) {
    Object.values(coursesSnap.val()).forEach(c => {
      total += c.time.split(",").filter(t => t.trim()).length;
    });
  }
  const traineesSnap = await get(ref(db, "trainees"));
  const busy = traineesSnap.exists() 
             ? Object.keys(traineesSnap.val()).length 
             : 0;
  totalCount.textContent     = total;
  takenCount.textContent     = busy;
  availableCount.textContent = total - busy;
}

// 5) ÙØªØ­ Ø§Ù„Ù…ÙˆØ¯Ø§Ù„ ÙˆØ¨Ù†Ø§Ø¡ Ø§Ù„ÙØªØ±Ø§Øª
async function openModal(courseId) {
  const snap   = await get(ref(db, "courses/" + courseId));
  const course = snap.val();
  currentCourse = { id: courseId, ...course };
  selectedDate  = null;
  document.getElementById("selectedCourseId").value = courseId;
  await renderPeriods(currentCourse);
  modal.style.display = "flex";
}

async function renderPeriods(course) {
  periodsGrid.innerHTML = "";
  const dates = course.date.split(",").map(d=>d.trim());
  const times = course.time.split(",").map(t=>t.trim());
  const traineesSnap = await get(ref(db, "trainees"));
  const takenSlots = new Set(
    traineesSnap.exists()
      ? Object.values(traineesSnap.val())
          .filter(t => t.courseId === course.id)
          .map(t => `${t.date}_${t.time}`)
      : []
  );

  // ØªÙˆØ§Ø±ÙŠØ®
  const datesDiv = document.createElement("div");
  datesDiv.style.marginBottom = "20px";
  datesDiv.innerHTML = `<h4>Ø§Ø®ØªØ± Ø§Ù„ØªØ§Ø±ÙŠØ®</h4>`;
  dates.forEach((date,i) => {
    const box = document.createElement("div");
    box.className = "period-box" + 
      (takenSlots.has(`${date}_${times[i]}`) ? " disabled" : "");
    box.textContent = date;
    box.onclick = () => {
      if (box.classList.contains("disabled")) return;
      selectedDate = date;
      datesDiv.querySelectorAll(".period-box")
              .forEach(b=>b.classList.remove("selected"));
      box.classList.add("selected");
      // ØªÙØ¹ÙŠÙ„/ØªØ¹Ø·ÙŠÙ„ Ø§Ù„Ø£ÙˆÙ‚Ø§Øª
      timesDiv.querySelectorAll(".period-box").forEach((tb,j)=>{
        if (j===i && !takenSlots.has(`${date}_${times[j]}`)) {
          tb.classList.remove("disabled");
        } else {
          tb.classList.add("disabled");
          tb.classList.remove("selected");
        }
      });
    };
    datesDiv.appendChild(box);
  });
  periodsGrid.appendChild(datesDiv);

  // Ø£ÙˆÙ‚Ø§Øª
  const timesDiv = document.createElement("div");
  timesDiv.innerHTML = `<h4>Ø§Ø®ØªØ± Ø§Ù„ÙˆÙ‚Øª</h4>`;
  times.forEach((time,i)=>{
    const box = document.createElement("div");
    box.className = "period-box disabled";
    box.textContent = time;
    box.onclick = () => {
      if (box.classList.contains("disabled")) return;
      selectedPeriod = time;
      timesDiv.querySelectorAll(".period-box")
             .forEach(b=>b.classList.remove("selected"));
      box.classList.add("selected");
    };
    timesDiv.appendChild(box);
  });
  periodsGrid.appendChild(timesDiv);
}

// 6) Ù…Ø¹Ø§Ù„Ø¬Ø© Ø§Ù„Ø¥Ø±Ø³Ø§Ù„
form.addEventListener("submit", async e => {
  e.preventDefault();

  // ØªØ­Ù‚Ù‚ Ù…Ù† Ø§Ø®ØªÙŠØ§Ø± Ø§Ù„ØªØ§Ø±ÙŠØ® ÙˆØ§Ù„ÙˆÙ‚Øª
  if (!selectedDate)   return alert("Ø§Ù„Ø±Ø¬Ø§Ø¡ Ø§Ø®ØªÙŠØ§Ø± Ø§Ù„ØªØ§Ø±ÙŠØ®.");
  if (!selectedPeriod) return alert("Ø§Ù„Ø±Ø¬Ø§Ø¡ Ø§Ø®ØªÙŠØ§Ø± Ø§Ù„ÙØªØ±Ø©.");

 

  try {
    // ØªØ£ÙƒØ¯ Ø£Ù† Ø§Ù„ÙØªØ±Ø© ØºÙŠØ± Ù…Ø­Ø¬ÙˆØ²Ø©
    const traineesSnap = await get(ref(db,"trainees"));
    const allTrainees = traineesSnap.exists()
      ? Object.values(traineesSnap.val())
      : [];
    if (allTrainees.some(t =>
      t.courseId===currentCourse.id &&
      t.date===selectedDate &&
      t.time===selectedPeriod)) {
      return alert("Ù‡Ø°Ù‡ Ø§Ù„ÙØªØ±Ø© Ù…Ø­Ø¬ÙˆØ²Ø© Ø¨Ø§Ù„ÙØ¹Ù„.");
    }
 // ØªØ­Ù‚Ù‚ Ù…Ù† Ø±ÙØ¹ Ø§Ù„Ø³ÙŠØ±Ø©
 const cvInput = document.getElementById("cvFile");
let cvUrl = "";                             // Ø§ÙØªØ±Ø§Ø¶ÙŠÙ‹Ø§ ÙØ§Ø¶ÙŠ
if (cvInput.files.length > 0) {             // ÙÙ‚Ø· Ù„Ùˆ Ø§Ø®ØªØ§Ø± Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù… Ù…Ù„Ù
  const file = cvInput.files[0];            // Ø®Ø° Ø£ÙˆÙ„ Ù…Ù„Ù
  const path = `cv-mdrb/${file.name}`;      // Ù…Ø³Ø§Ø± Ø§Ù„ØªØ®Ø²ÙŠÙ†
  const sRef = storageRef(storage, path);   // Ø¥Ù†Ø´Ø§Ø¡ reference
  await uploadBytes(sRef, file);            // Ø§Ø±ÙØ¹ Ø§Ù„Ù…Ù„Ù
  cvUrl = await getDownloadURL(sRef);       // Ø§Ø­ØµÙ„ Ø¹Ù„Ù‰ Ø§Ù„Ø±Ø§Ø¨Ø·
}



    // Ø¬Ù…Ø¹ Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª
    const traineeData = {
      name:        form.name.value.trim(),
      workname:    form.workname.value.trim(),
      email:       form.email.value.trim(),
      phone:       form.phone.value.trim(),
      nationalId:  form.nationalId.value.trim(),
      courseId:    currentCourse.id,
      courseTitle: currentCourse.title,
      date:        selectedDate,
      time:        selectedPeriod,
      cvUrl,
      duration:    currentCourse.duration,
      place:       currentCourse.place||"",
      category:    currentCourse.category||"",
      target:      currentCourse.target||"",
      registeredAt:new Date().toISOString()
    };

    // Ø­ÙØ¸ ÙÙŠ Realtime DB
    const newRef = push(ref(db,"trainees"));
    await set(newRef, traineeData);

    // ØªØ£ÙƒÙŠØ¯ ÙˆØ¥Ø¹Ø§Ø¯Ø© ØªØ­Ù…ÙŠÙ„ Ø§Ù„Ù‚Ø§Ø¦Ù…Ø©
    successMsg.style.display = "block";
    form.querySelector("button").disabled = true;
    setTimeout(()=>{
      window.closeModal();
      form.querySelector("button").disabled = false;
      fetchCourses();
    },2000);

  } catch(err) {
    console.error(err);
    alert("Ø®Ø·Ø£ Ø£Ø«Ù†Ø§Ø¡ Ø§Ù„ØªØ³Ø¬ÙŠÙ„: "+err.message);
  }
});

// 7) ØªØ´ØºÙŠÙ„ Ø£ÙˆÙ„ÙŠ
fetchCourses();
</script>

</body>
</html>